import requests
import pandas as pd
import time
import datetime
from concurrent.futures import ThreadPoolExecutor
from colorama import init, Fore, Style
from tabulate import tabulate

# --- åˆå§‹åŒ–é…ç½® ---
init(autoreset=True)  # åˆå§‹åŒ–é¢œè‰²åº“

class Level1Scanner:
    def __init__(self):
        self.base_url = "https://fapi.binance.com"
        self.symbols = []
        self.scan_interval = 120  # æ‰«æé—´éš” (ç§’)
        # æ ¸å¿ƒå‚æ•°å®šä¹‰ (å¯¹åº” PRD ç¬¬äº”ç« )
        self.vol_factor = 2.5       # Aç±»/Cç±»: æˆäº¤é‡æ”¾å¤§å€æ•°
        self.trend_threshold = 0.05 # Aç±»: ä»·æ ¼æ¶¨è·Œå¹… 5%
        self.lookback_4h = 16       # Aç±»: 4å°æ—¶ = 16æ ¹ 15m Kçº¿
        self.accel_single = 0.08    # Bç±»: å•æ ¹æç«¯ 8%
        self.accel_accum = 0.07     # Bç±»: ç´¯è®¡åŠ é€Ÿ 7%
        self.fail_shock = 0.06      # Cç±»: å†²å‡»å¹…åº¦ 6%

    # --- 1. è·å–å¸‚åœºèŒƒå›´ (å¯¹åº” PRD ç¬¬å››ç« ) ---
    def get_active_symbols(self):
        try:
            url = f"{self.base_url}/fapi/v1/exchangeInfo"
            resp = requests.get(url).json()
            # ç­›é€‰ï¼šæ­£åœ¨äº¤æ˜“çš„ USDT æ°¸ç»­åˆçº¦
            self.symbols = [
                s['symbol'] for s in resp['symbols'] 
                if s['status'] == 'TRADING' and s['quoteAsset'] == 'USDT' and s['contractType'] == 'PERPETUAL'
            ]
            print(f"{Fore.CYAN}[ç³»ç»Ÿ] è·å–åˆ° {len(self.symbols)} ä¸ªæ´»è·ƒåˆçº¦ï¼Œå‡†å¤‡å¼€å§‹æ‰«æ...{Style.RESET_ALL}")
            return self.symbols
        except Exception as e:
            print(f"{Fore.RED}[é”™è¯¯] è·å–äº¤æ˜“å¯¹å¤±è´¥: {e}{Style.RESET_ALL}")
            return []

    # --- 2. è·å– K çº¿æ•°æ® (å¯¹åº” PRD ç¬¬ä¸‰ç« ) ---
    def get_klines(self, symbol, interval='15m', limit=50):
        try:
            url = f"{self.base_url}/fapi/v1/klines"
            params = {'symbol': symbol, 'interval': interval, 'limit': limit}
            resp = requests.get(url, params=params, timeout=5)
            data = resp.json()
            # è½¬æ¢ä¸º DataFrameä¾¿äºè®¡ç®—
            df = pd.DataFrame(data, columns=[
                'open_time', 'open', 'high', 'low', 'close', 'volume', 
                'close_time', 'quote_asset_volume', 'trades', 'taker_buy_base', 'taker_buy_quote', 'ignore'
            ])
            # ç±»å‹è½¬æ¢
            cols = ['open', 'high', 'low', 'close', 'volume']
            df[cols] = df[cols].astype(float)
            return df
        except Exception:
            return None

    # --- 3. æ ¸å¿ƒå¼‚åŠ¨è¯†åˆ«é€»è¾‘ (å¯¹åº” PRD ç¬¬äº”ç« ) ---
    def analyze_symbol(self, symbol):
        # 15m æ˜¯ä¸»æ‰«æå‘¨æœŸ
        df_15m = self.get_klines(symbol, '15m', 50)
        if df_15m is None or len(df_15m) < 25: 
            return None

        # æå–æœ€æ–°ä¸€æ ¹å·²å®Œæˆçš„ K çº¿ (å€’æ•°ç¬¬äºŒæ ¹ï¼Œå› ä¸ºæœ€åä¸€æ ¹æ˜¯æœªå®Œæˆçš„)
        # âš ï¸ æ³¨æ„ï¼šä¸ºäº†å®æ—¶æ€§ï¼Œä¹Ÿå¯ä»¥å–æœ€åä¸€æ ¹(current)ï¼Œä½†éœ€æ³¨æ„æ”¶ç›˜ä»·æœªå®šã€‚
        # ä¾ç…§ PRD "å½“å‰ 15m" ä¸”ç»“åˆå®æˆ˜ï¼Œæˆ‘ä»¬é€šå¸¸æ‰«æ "åˆšæ”¶ç›˜çš„" æˆ–è€… "å³æ—¶è·³åŠ¨çš„"
        # è¿™é‡Œä¸ºäº†ç¨³å¥ï¼Œæˆ‘ä»¬å– df.iloc[-1] ä½œä¸ºå½“å‰æ­£åœ¨è¿›è¡Œçš„ K çº¿è¿›è¡Œå®æ—¶ç›‘æµ‹
        curr = df_15m.iloc[-1] 
        prev = df_15m.iloc[-2]
        
        # åŸºç¡€è®¡ç®—
        close = curr['close']
        open_p = curr['open']
        high = curr['high']
        low = curr['low']
        vol = curr['volume']
        
        # æ¶¨è·Œå¹…
        pct_change = (close - open_p) / open_p
        abs_change = abs(pct_change)
        
        # å‡é‡ (å–å‰20æ ¹ï¼Œä¸å«å½“å‰)
        vol_ma20 = df_15m['volume'].iloc[-21:-1].mean()
        if vol_ma20 == 0: vol_ma20 = 1 # é˜²æ­¢é™¤é›¶
        vol_ratio = vol / vol_ma20

        # 4H ç»“æ„ (è¿‡å» 16 æ ¹ 15m çš„é«˜ä½ç‚¹ï¼Œä¸å«å½“å‰)
        high_4h = df_15m['high'].iloc[-17:-1].max()
        low_4h = df_15m['low'].iloc[-17:-1].min()

        alerts = []

        # --- ğŸ… ç±»å‹ Aï¼šè¶‹åŠ¿å¯åŠ¨ ---
        # é€»è¾‘ï¼šæ¶¨è·Œå¹… >= 5% ä¸” çªç ´4Hç»“æ„ ä¸” æ”¾é‡ 2.5å€
        is_type_a = False
        if abs_change >= self.trend_threshold and vol_ratio >= self.vol_factor:
            if pct_change > 0 and close > high_4h:
                alerts.append(self.format_alert('A', symbol, 'è¶‹åŠ¿å¯åŠ¨(å¤š)', pct_change, vol_ratio, f"çªç ´4Hé«˜ç‚¹ {high_4h}"))
                is_type_a = True
            elif pct_change < 0 and close < low_4h:
                alerts.append(self.format_alert('A', symbol, 'è¶‹åŠ¿å¯åŠ¨(ç©º)', pct_change, vol_ratio, f"è·Œç ´4Hä½ç‚¹ {low_4h}"))
                is_type_a = True

        # --- ğŸ…‘ ç±»å‹ Bï¼šåŠ é€Ÿ/å¤±æ§ ---
        # é€»è¾‘1ï¼šå•æ ¹ >= 8%
        if not is_type_a: # é¿å…é‡å¤æŠ¥è­¦ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥å¹¶å­˜
            if abs_change >= self.accel_single:
                alerts.append(self.format_alert('B', symbol, 'æç«¯å•æ ¹', pct_change, vol_ratio, "æƒ…ç»ªå¤±æ§"))
            
            # é€»è¾‘2ï¼šè¿ç»­åŠ é€Ÿ (å½“å‰å’Œä¸Šä¸€æ ¹åŒå‘ï¼Œä¸”éƒ½ > 3%ï¼Œç´¯è®¡ > 7%)
            prev_pct = (prev['close'] - prev['open']) / prev['open']
            if (pct_change * prev_pct > 0) and \
               (abs(prev_pct) >= 0.03 and abs_change >= 0.03) and \
               (abs(pct_change + prev_pct) >= self.accel_accum):
                alerts.append(self.format_alert('B', symbol, 'è¿ç»­åŠ é€Ÿ', pct_change+prev_pct, vol_ratio, "è¿ç»­ä¸¤æ ¹æš´èµ°"))

        # --- ğŸ…’ ç±»å‹ Cï¼šå¤±è´¥å¼‚åŠ¨/æ½œåœ¨åè½¬ ---
        # é€»è¾‘ï¼šæ—¥å†…å†²å‡» >= 6% ä½† æ”¶ç›˜æœªç«™ç¨³ 4H + æ”¾é‡
        # è¿™æ˜¯ä¸€ä¸ª"æ½œåœ¨"åˆ¤å®šï¼Œå› ä¸ºä¸¥æ ¼çš„ Type C éœ€è¦çœ‹éšåçš„ 5m
        shock_range = (high - low) / open_p
        if shock_range >= self.fail_shock and vol_ratio >= 2.0:
            # å†²é«˜å›è½ (ä¸Šå½±çº¿é•¿)
            if pct_change > 0 and close < high_4h: 
                # è¿™é‡Œç®€åŒ–å¤„ç†ï¼šå¦‚æœå†²å‡»å¾ˆå¤§ï¼Œä½†æ”¶ç›˜æ²¡èƒ½æœ‰æ•ˆçªç ´(æ¯”å¦‚ç•™é•¿ä¸Šå½±)ï¼Œæç¤ºå…³æ³¨
                # è®¡ç®—ä¸Šå½±çº¿é•¿åº¦
                upper_wick = (high - close) / open_p
                if upper_wick > 0.02: # ä¸Šå½±çº¿ > 2%
                    alerts.append(self.format_alert('C', symbol, 'æ½œåœ¨å¤šå¤´è¡°ç«­', pct_change, vol_ratio, "æ”¾é‡å†²é«˜å›è½"))
            
            # æ¢åº•å›å‡ (ä¸‹å½±çº¿é•¿)
            elif pct_change < 0 and close > low_4h:
                lower_wick = (close - low) / open_p
                if lower_wick > 0.02:
                    alerts.append(self.format_alert('C', symbol, 'æ½œåœ¨ç©ºå¤´è¡°ç«­', pct_change, vol_ratio, "æ”¾é‡æ¢åº•å›å‡"))

        return alerts

    def format_alert(self, type_code, symbol, reason, pct, vol_r, note):
        # é¢œè‰²å®šä¹‰
        color = Fore.WHITE
        if type_code == 'A': color = Fore.GREEN if pct > 0 else Fore.RED
        if type_code == 'B': color = Fore.YELLOW
        if type_code == 'C': color = Fore.MAGENTA
        
        direction = "ğŸ“ˆ ä¸Šæ¶¨" if pct > 0 else "ğŸ“‰ ä¸‹è·Œ"
        
        return [
            f"{color}{type_code}{Style.RESET_ALL}",
            f"{Style.BRIGHT}{symbol}{Style.RESET_ALL}",
            datetime.datetime.now().strftime("%H:%M"),
            f"{color}{direction} {pct*100:.2f}%{Style.RESET_ALL}",
            f"Vol x{vol_r:.1f}",
            f"{note}"
        ]

    # --- 4. ä¸»è¿è¡Œå¾ªç¯ (å¯¹åº” PRD ç¬¬å…­ç« /å…«ç« ) ---
    def run(self):
        print(f"{Fore.YELLOW}ğŸ“¡ å¼‚åŠ¨é›·è¾¾ (Level 1 Scanner) v0.0 å¯åŠ¨ä¸­...{Style.RESET_ALL}")
        print("é€‚ç”¨èŒƒå›´: Binance USDT æ°¸ç»­åˆçº¦")
        print("----------------------------------------------------")
        
        self.get_active_symbols()
        
        while True:
            print(f"\n{Fore.CYAN}>>> å¼€å§‹æ‰«æ ({datetime.datetime.now().strftime('%H:%M:%S')}) - ç›®æ ‡: {len(self.symbols)} ä¸ªæ ‡çš„{Style.RESET_ALL}")
            results = []
            
            # ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘æ‰«æï¼Œæé«˜é€Ÿåº¦
            with ThreadPoolExecutor(max_workers=10) as executor:
                # æäº¤æ‰€æœ‰ä»»åŠ¡
                futures = {executor.submit(self.analyze_symbol, sym): sym for sym in self.symbols}
                
                for future in futures:
                    res = future.result()
                    if res:
                        results.extend(res)
            
            # è¾“å‡ºç»“æœ
            if results:
                print(f"\nğŸ”¥ {Fore.RED}å‘ç°å¼‚åŠ¨ä¿¡å·!{Style.RESET_ALL}")
                headers = ["Type", "Symbol", "Time", "Change(15m)", "Volume", "Structure Note"]
                print(tabulate(results, headers=headers, tablefmt="fancy_grid"))
            else:
                print("ğŸ’¤ å¸‚åœºå¹³é™ï¼Œæ— ç¬¦åˆå®šä¹‰ (A/B/C) çš„ç»“æ„æ€§å¼‚åŠ¨ã€‚")

            print(f"â³ ç­‰å¾… {self.scan_interval} ç§’åè¿›è¡Œä¸‹ä¸€è½®æ‰«æ...")
            time.sleep(self.scan_interval)

if __name__ == "__main__":
    scanner = Level1Scanner()
    scanner.run()